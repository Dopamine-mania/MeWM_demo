# MeWM《数据增补清单》（给客户/数据方）

目标：补齐能够**端到端跑通 MeWM 全链路**所需的数据（数据输入 → 预处理 → 训练脚本跑 1 个 epoch → 推理产出结果），不要求复现论文指标。

> 结论先说：仅有几 GB 的原始 CT DICOM（且缺少 post-treatment、mask、治疗文本、生存结局）不足以支撑 MeWM 的“生成→分割→逆动力学生存”闭环。请按下方清单补齐。

---

## 1) 必需数据（Must-have）

以 **HCC-TACE-Seg**（或等价格式）为目标，最少需要每位患者/每个病例一组 **治疗前 pre** 与 **治疗后 post** 的配对数据：

### 1.1 影像（pre / post）

建议提供 **NIfTI**（`.nii.gz`）以便快速对齐训练脚本；若只能提供 DICOM，请看第 6 节。

- `pre_ct.nii.gz`：治疗前 CT（3D）
- `post_ct.nii.gz`：治疗后 CT（3D）

要求：
- pre 与 post 应为同一患者，且时间顺序明确（可提供检查日期字段）
- 空间信息完整（spacing/origin/direction/affine），且与 mask 对齐
- 若 pre/post 未配准（registered），请注明；最好能额外提供配准后的版本（见 Optional）

### 1.2 标注（mask，pre / post）

至少需要肿瘤标注；为了支持代码里常见的 3 类分割/裁剪策略，推荐同时提供器官（肝）标注。

建议 mask 编码（与项目代码常用约定对齐）：
- `0`：背景
- `1`：肝脏（organ）
- `2`：肿瘤（tumor）

对应文件：
- `pre_mask.nii.gz`：治疗前 mask（与 `pre_ct.nii.gz` 同尺寸同空间）
- `post_mask.nii.gz`：治疗后 mask（与 `post_ct.nii.gz` 同尺寸同空间）

最低可接受：
- 只有肿瘤二值 mask（0/1）也可以，但会限制部分训练/增强逻辑；请提前说明。

### 1.3 治疗方案文本（Action / Plan）

MeWM 的生成模块需要“治疗动作”作为条件输入（文本/结构化均可）。最简单做法：为每个 pre→post 配对提供一条可读的动作描述字符串。

必需字段（至少之一）：
- TACE 化疗药物集合（drug set）
- 栓塞材料集合（embolism set）

推荐提供：
- 结构化字段（药物、剂量、次数、栓塞材料、是否 cTACE/DEB-TACE 等）
- 同时给出一个“拼接后的文本 action”，便于直接喂给扩散模型/Mock policy

### 1.4 生存结局（Survival）

逆动力学/生存模块至少需要：
- `survival_time_months`：生存时长（**单位：月**，代码里常用 `>=60` 判定 5 年）
- `event_indicator`：是否发生事件（推荐：`1=事件发生/死亡`，`0=删失`）

建议补充：
- 起算日期（如 `treatedate` 或 `initialdate`）
- 末次随访/死亡日期（如 `lastdate`）
- OS / RFS 两种结局可分别提供（若有）

---

## 2) 推荐目录结构（强烈建议按此交付）

为了兼容现有代码里对路径分段的依赖，建议所有路径都满足至少 3 级：`<dataset>/<patient_id>/<file>`

示例（建议放在同一个数据根目录下）：

```
hcc_tace_seg/
  hcc/
    HCC_001/
      pre_ct.nii.gz
      pre_mask.nii.gz
      post_ct.nii.gz
      post_mask.nii.gz
    HCC_002/
      ...
  meta/
    treatment.tsv
    survival.tsv
  lists/
    train_paired.txt
    val_paired.txt
```

---

## 3) 必需表格文件（强烈建议提供，便于追溯与重建列表）

### 3.1 `meta/treatment.tsv`（治疗信息表）

**一行一条配对（patient_id + pre/post）或一行一位患者**均可，但必须能唯一关联到 pre/post 影像。

推荐字段（TSV，制表符分隔）：
- `patient_id`
- `pre_series_uid`（可选，但若有 DICOM 更好）
- `post_series_uid`（可选）
- `drug_set`（如用 `;` 拼接：`Epirubicin;Oxaliplatin`）
- `embolism_set`（如 `Lipiodol;Gelatin Sponge`）
- `action_text`（最终喂给模型的文本，允许为空但不建议）
- `tace_date`（可选）

### 3.2 `meta/survival.tsv`（生存结局表）

推荐字段：
- `patient_id`
- `survival_time_months`
- `event_indicator`（1/0）
- `endpoint_type`（可选：OS/RFS）
- `start_date` / `last_followup_date`（可选）

---

## 4) 训练/推理所需的“列表文件”格式（与代码对齐的建议格式）

项目里多处读取方式是“按列取值”，为了减少我们改代码的成本，建议按下面的 **10 列 TSV** 交付列表文件。

### 4.1 列表文件：`lists/train_paired.txt`、`lists/val_paired.txt`

每行 10 列（TSV），列含义如下（相对路径相对于数据根目录 `hcc_tace_seg/`）：

1. `pre_ct_path`（例：`hcc/HCC_001/pre_ct.nii.gz`）
2. `pre_mask_path`（例：`hcc/HCC_001/pre_mask.nii.gz`）
3. `pre_aux_1`（占位/可留空：`-`）
4. `pre_aux_2`（占位/可留空：`-`）
5. `post_ct_path`（例：`hcc/HCC_001/post_ct.nii.gz`）
6. `post_mask_path`（例：`hcc/HCC_001/post_mask.nii.gz`）
7. `action_text`（例：`Oxaliplatin;Lipiodol` 或更完整自然语言）
8. `pair_id`（建议：`HCC_001` 或 `HCC_001_visit1`，便于追溯）
9. `survival_time_months`（例：`48`）
10. `event_indicator`（例：`1`）

示例行（仅示意）：

```
hcc/HCC_001/pre_ct.nii.gz	hcc/HCC_001/pre_mask.nii.gz	-	-	hcc/HCC_001/post_ct.nii.gz	hcc/HCC_001/post_mask.nii.gz	Epirubicin;Lipiodol	HCC_001	48	1
```

说明：
- 之所以保留第 3/4 列“占位”，是因为现有代码默认会访问第 5/6 列作为 post 的 image/label。
- action_text 可用结构化拼接字符串（推荐分号 `;`），也可用自然语言，但需稳定可复现。

---

## 5) 标注与对齐要求（避免“能读但训练崩”）

请尽量满足：
- `pre_ct` 与 `pre_mask`：尺寸一致、空间一致（同 affine/spacing/origin/direction）
- `post_ct` 与 `post_mask`：同上
- mask 值域干净：只包含 `0/1/2`（或双方约定的有限类别）
- 若同一患者有多期（多次 TACE / 多次随访），请在 `pair_id` 或文件名中体现期次

推荐额外提供 QA 信息（可选）：
- 每个病例肿瘤体素数/体积统计（便于过滤空 mask）
- pre/post 是否已配准的标记

---

## 6) 若只能提供 DICOM（也可，但请补齐这些）

如果暂时无法提供 NIfTI，请至少提供：

### 6.1 DICOM 影像序列（pre / post）
- 每个病例的 pre CT DICOM 文件夹（完整序列）
- 每个病例的 post CT DICOM 文件夹（完整序列）

并提供一个 `dicom_index.tsv`（推荐）：
- `patient_id`
- `timepoint`（pre/post）
- `study_uid`
- `series_uid`
- `series_description`
- `dicom_dir_relative_path`

### 6.2 DICOM 标注（SEG / RTSTRUCT）
- DICOM-SEG（首选）或 RTSTRUCT
- 必须能明确映射到对应的 CT `SeriesInstanceUID`（或同 FrameOfReferenceUID）
- 若一个 SEG 里多段（liver/tumor），请注明 segment label 与编号映射

> 注意：DICOM 转 NIfTI + SEG/RTSTRUCT 转 mask 需要额外处理（项目将实现），但前提是映射关系清晰且数据完整。

---

## 7) 最小可用交付（为了尽快调通）

如果数据方无法一次性给全量，请先给一个“最小子集”用于验证全链路：
- 5–10 位患者
- 每位都有 pre/post CT + pre/post mask + action_text + survival_time_months + event_indicator

这足以：
- 跑通预处理与数据加载
- 让训练脚本跑 1 个 epoch 验证逻辑
- 推理脚本输出结果文件（不保证医学质量）

---

## 8) 需要你确认的 2 个约定（请客户回复）

1) `survival_time_months` 的口径：从 `treatedate` 起算还是从 `initialdate` 起算？
2) `event_indicator` 的定义：`1=死亡/复发`、`0=删失` 是否成立？（若相反请注明）

